<div class="medical-container">
  <p-toast></p-toast>
  
  <p-card [style]="{'margin-bottom': '2rem'}">
    <ng-template pTemplate="header">
      <div class="search-header">
        <i class="pi pi-search" style="font-size: 2rem; color: #fff; margin-right: 1rem;"></i>
        <div>
          <h2>Search Patient</h2>
          <p>Find patients by National ID or name</p>
        </div>
      </div>
    </ng-template>
    <div class="p-fluid">
      <span class="p-input-icon-left w-full mb-3">
        <i class="pi pi-search"></i>
        <input 
          id="searchTerm" 
          type="text" 
          pInputText 
          [(ngModel)]="searchTerm" 
          (keyup.enter)="onSearch()"
          placeholder="Enter National ID or patient name"
          class="w-full"
          [style]="{'padding-left': '2.5rem'}"
        />
      </span>
      <p-button 
        label="Search" 
        icon="pi pi-search" 
        (onClick)="onSearch()"
        [loading]="loading"
        styleClass="w-full"
      ></p-button>
    </div>
  </p-card>

  <p-card *ngIf="patients.length > 0" header="Search Results" class="medical-card">
    <p-table [value]="patients" [paginator]="true" [rows]="10">
      <ng-template pTemplate="header">
        <tr>
          <th>National ID</th>
          <th>Name</th>
          <th>Date of Birth</th>
          <th>Gender</th>
          <th>Phone</th>
          <th>Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-patient>
        <tr (click)="selectPatient(patient)" style="cursor: pointer;">
          <td>{{ patient.nationalId }}</td>
          <td>{{ patient.firstName }} {{ patient.lastName }}</td>
          <td>{{ patient.dateOfBirth | date:'shortDate' }}</td>
          <td>{{ patient.gender || 'N/A' }}</td>
          <td>{{ patient.phoneNumber || 'N/A' }}</td>
          <td>
            <p-button 
              icon="pi pi-eye" 
              label="View Details" 
              [outlined]="true"
              (onClick)="selectPatient(patient); $event.stopPropagation()"
            ></p-button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <p-card *ngIf="selectedPatient" [style]="{'margin-top': '2rem'}">
    <ng-template pTemplate="header">
      <div class="patient-header">
        <p-avatar [label]="selectedPatient.firstName.charAt(0) + selectedPatient.lastName.charAt(0)" shape="circle" [style]="{'background-color': 'var(--primary-color)', 'color': '#fff', 'font-size': '1.5rem', 'width': '4rem', 'height': '4rem', 'margin-right': '1rem'}"></p-avatar>
        <div>
          <h2>{{ selectedPatient.firstName }} {{ selectedPatient.lastName }}</h2>
          <p class="text-color-secondary">Patient Information</p>
        </div>
      </div>
    </ng-template>
    <div class="patient-info-grid">
      <div class="info-item">
        <i class="pi pi-id-card"></i>
        <div>
          <label>National ID</label>
          <p>{{ selectedPatient.nationalId }}</p>
        </div>
      </div>
      <div class="info-item">
        <i class="pi pi-calendar"></i>
        <div>
          <label>Date of Birth</label>
          <p>{{ selectedPatient.dateOfBirth | date:'shortDate' }}</p>
        </div>
      </div>
      <div class="info-item">
        <i class="pi pi-user"></i>
        <div>
          <label>Gender</label>
          <p>{{ selectedPatient.gender || 'N/A' }}</p>
        </div>
      </div>
      <div class="info-item">
        <i class="pi pi-phone"></i>
        <div>
          <label>Phone</label>
          <p>{{ selectedPatient.phoneNumber || 'N/A' }}</p>
        </div>
      </div>
    </div>
    <p *ngIf="selectedPatient.notes" class="patient-notes">
      <i class="pi pi-info-circle mr-2"></i>
      <strong>Notes:</strong> {{ selectedPatient.notes }}
    </p>
    <p-divider></p-divider>

    <p-tabs>
      <p-tab header="Blood Tubes">
        <p-table [value]="patientTubes" [paginator]="true" [rows]="10">
          <ng-template pTemplate="header">
            <tr>
              <th>Barcode</th>
              <th>Rack Position</th>
              <th>Collection Date</th>
              <th>Status</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-tube>
            <tr>
              <td>{{ tube.barcodeNumber }}</td>
              <td>Row {{ tube.rackRow }}, Col {{ tube.rackColumn }}</td>
              <td>{{ tube.collectionDateTime | date:'short' }}</td>
              <td>
                <p-tag [value]="tube.status" [severity]="getStatusSeverity(tube.status)"></p-tag>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="text-center">No blood tubes found for this patient.</td>
            </tr>
          </ng-template>
        </p-table>
      </p-tab>

      <p-tab header="Lab Results">
        <p-table [value]="patientResults" [paginator]="true" [rows]="10">
          <ng-template pTemplate="header">
            <tr>
              <th>Test Type</th>
              <th>Result Values</th>
              <th>Status</th>
              <th>Date</th>
              <th>Performed By</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-result>
            <tr>
              <td>{{ result.testType }}</td>
              <td>
                <div *ngFor="let value of result.resultValues | keyvalue">
                  <strong>{{ value.key }}:</strong> {{ value.value }}
                </div>
              </td>
              <td>
                <p-tag 
                  [value]="result.resultStatus" 
                  [severity]="result.resultStatus === 'Final' ? 'success' : 'warn'"
                ></p-tag>
              </td>
              <td>{{ result.resultDateTime | date:'short' }}</td>
              <td>{{ result.performedByUserName }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="text-center">No lab results found for this patient.</td>
            </tr>
          </ng-template>
        </p-table>
      </p-tab>
    </p-tabs>
  </p-card>
</div>

